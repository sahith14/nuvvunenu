<!DOCTYPE html>
<html>
<head>
  <title>Set Up Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>

<body class="auth-body">

  <div class="auth-card glass">
    <h2>Complete Your Profile üíú</h2>

    <input id="setup-username" placeholder="Choose a username">
    <input id="setup-name" placeholder="Your full name">

    <button onclick="saveUserInfo()">Save</button>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // USERNAME ‚Üí SEARCH KEYWORD GENERATOR
    function generateKeywords(name) {
      name = name.toLowerCase();
      const arr = [];
      let cur = "";
      for (let c of name) {
        cur += c;
        arr.push(cur);
      }
      return arr;
    }
    import { collection, query, where, getDocs } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function usernameExists(username) {
      const q = query(
        collection(db, "users"),
        where("username", "==", username.toLowerCase())
      );
      const snap = await getDocs(q);
      return snap.size > 0;
    }
    
    window.saveUserInfo = async function () {
      const username = document.getElementById("setup-username").value.trim().toLowerCase();
      const name = document.getElementById("setup-name").value.trim();

      // 1Ô∏è‚É£ CHECK IF FIELDS ARE EMPTY
      if (!username || !name) {
        alert("Please fill all fields");
        return;
      }

      // 2Ô∏è‚É£ BLOCK SPECIAL SYMBOLS  (THIS IS WHERE YOUR CODE GOES)
      if (!/^[a-z0-9._]+$/.test(username)) {
        alert("Username can contain only letters, numbers, . and _");
        return;
      }

      // 3Ô∏è‚É£ CHECK IF USERNAME IS TAKEN
      if (await usernameExists(username)) {
        alert("This username is already taken. Try another.");
        return;
      }

      // 4Ô∏è‚É£ SAVE USER INFO
      const uid = auth.currentUser.uid;

      await setDoc(doc(db, "users", uid), {
        username,
        name,
        searchKeywords: generateKeywords(username),
      }, { merge: true });

      window.location.href = "app.html";
    };
  </script>
</body>
</html>
